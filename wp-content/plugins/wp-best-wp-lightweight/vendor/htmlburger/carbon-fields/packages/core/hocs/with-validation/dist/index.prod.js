"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _callbagDropUntil=_interopRequireDefault(require("callbag-drop-until")),_callbagDistinctUntilChanged=_interopRequireDefault(require("callbag-distinct-until-changed")),_hooks=require("@wordpress/hooks"),_compose=require("@wordpress/compose"),_data=require("@wordpress/data"),_refractCallbag=require("refract-callbag"),_callbagDebounce=require("callbag-debounce"),_callbagBasics=require("callbag-basics"),_required=_interopRequireDefault(require("./required"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,a){return _arrayWithHoles(e)||_iterableToArrayLimit(e,a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,a){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],t=!0,l=!1,i=void 0;try{for(var n,c=e[Symbol.iterator]();!(t=(n=c.next()).done)&&(r.push(n.value),!a||r.length!==a);t=!0);}catch(e){l=!0,i=e}finally{try{t||null==c.return||c.return()}finally{if(l)throw i}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function aperture(e,a){if(a.field.required){var r=e.mount,t=e.unmount,l=e.observe("value"),i=e.observe("visible");return(0,_callbagBasics.merge)((0,_callbagBasics.pipe)((0,_callbagBasics.combine)(l,i,r),(0,_callbagBasics.filter)(function(e){return _slicedToArray(e,2)[1]}),(0,_callbagBasics.take)(1),(0,_callbagBasics.map)(function(e){return{type:"VALIDATE",payload:{value:_slicedToArray(e,1)[0],transient:!0}}})),(0,_callbagBasics.pipe)(l,(0,_callbagDropUntil.default)(r),(0,_callbagDistinctUntilChanged.default)(),(0,_callbagDebounce.debounce)(250),(0,_callbagBasics.map)(function(e){return{type:"VALIDATE",payload:{value:e,transient:!1}}})),(0,_callbagBasics.pipe)(t,(0,_callbagBasics.map)(function(){return{type:"RESET"}})))}}function handler(d){return function(e){var a=d.id,r=d.field,t=d.markAsInvalid,l=d.markAsValid,i=d.lockSaving,n=d.unlockSaving;switch(e.type){case"VALIDATE":var c=e.payload,o=c.value,s=c.transient,u="carbon-fields.".concat(r.type,".validate"),p=(0,_hooks.hasFilter)(u)?(0,_hooks.applyFilters)(u,r,o):(0,_required.default)(o);p?(s||t(a,p),i(a)):(s||l(a),n(a));break;case"RESET":l(a),n(a)}}}var applyWithEffects=(0,_refractCallbag.withEffects)(aperture,{handler:handler}),applyWithDispatch=(0,_data.withDispatch)(function(e){var a=e("carbon-fields/core");return{markAsValid:a.markAsValid,markAsInvalid:a.markAsInvalid}}),_default=(0,_compose.compose)(applyWithDispatch,applyWithEffects);exports.default=_default;