"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _data=require("@wordpress/data"),_element=require("@wordpress/element"),_lodash=require("lodash"),_refractCallbag=require("refract-callbag"),_callbagBasics=require("callbag-basics"),_urldecode=_interopRequireDefault(require("../../utils/urldecode")),_flattenField=_interopRequireDefault(require("../../utils/flatten-field")),_fromEventPattern=_interopRequireDefault(require("../../utils/from-event-pattern")),_containers=require("../../containers"),_constants=require("../../lib/constants");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],r=!0,a=!1,i=void 0;try{for(var o,d=e[Symbol.iterator]();!(r=(o=d.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){a=!0,i=e}finally{try{r||null==d.return||d.return()}finally{if(a)throw i}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function WidgetHandler(){return null}function isCarbonFieldsWidget(e){return-1<e.indexOf(_constants.CARBON_FIELDS_CONTAINER_WIDGET_ID_PREFIX)}function aperture(){return(0,_callbagBasics.merge)((0,_callbagBasics.pipe)((0,_fromEventPattern.default)(function(e){return window.jQuery(document).on("widget-added widget-updated",e)},function(e){return window.jQuery(document).off("widget-added widget-updated",e)},function(e,t){return{event:e,$widget:t}}),(0,_callbagBasics.filter)(function(e){return isCarbonFieldsWidget(e.$widget[0].id)}),(0,_callbagBasics.map)(function(e){return{type:"WIDGET_CREATED_OR_UPDATED",payload:e}})),(0,_callbagBasics.pipe)((0,_fromEventPattern.default)(function(e){return window.jQuery(document).on("ajaxSend",e)},function(e){return window.jQuery(document).off("ajaxSend",e)},function(e,t,n,r){return{event:e,xhr:t,options:n,data:r}}),(0,_callbagBasics.filter)(function(e){var t=e.options;return(0,_lodash.startsWith)(t.data,_constants.CARBON_FIELDS_CONTAINER_ID_PREFIX)}),(0,_callbagBasics.map)(function(e){return{type:"WIDGET_BEIGN_UPDATED_OR_DELETED",payload:e}})))}function handler(){return function(e){var t=(0,_data.select)("carbon-fields/metaboxes").getContainerById,n=(0,_data.dispatch)("carbon-fields/metaboxes"),r=n.addContainer,a=n.removeContainer,i=n.addFields,o=n.removeFields;switch(e.type){case"WIDGET_CREATED_OR_UPDATED":var d,l=e.payload,u=l.event,c=l.$widget,s=(0,_lodash.flow)(_urldecode.default,JSON.parse)(c.find("[data-json]").data("json")),f=[];s.fields=s.fields.map(function(e){return(0,_flattenField.default)(e,s,f)}),i(f),r(s),(0,_containers.renderContainer)(s,"classic"),window.cf.config.pagenow===_constants.PAGE_NOW_CUSTOMIZE&&"widget-added"===u.type&&(d=c.find('[name="widget-id"]').val(),c.find('[name="savewidget"]').show().end().find(".widget-content:first").off("keydown","input").off("change input propertychange",":input"),wp.customize.Widgets.getWidgetFormControlForWidget(d).liveUpdateMode=!1);break;case"WIDGET_BEIGN_UPDATED_OR_DELETED":var p=_slicedToArray(e.payload.options.data.match(/widget-id=(.+?)&/),2)[1],g="".concat(_constants.CARBON_FIELDS_CONTAINER_ID_PREFIX).concat(p),E=t(g);(0,_element.unmountComponentAtNode)(document.querySelector(".container-".concat(g)));var m=_.map(E.fields,"id");a(g),o(m)}}}var _default=(0,_refractCallbag.withEffects)(aperture,{handler:handler})(WidgetHandler);exports.default=_default;