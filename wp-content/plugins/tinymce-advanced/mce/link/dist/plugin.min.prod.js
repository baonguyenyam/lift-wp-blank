"use strict";!function(d){function T(e){return e.target_list}function t(e){return e.rel_list}function C(e){return e.link_class_list}function M(e){return void 0!==t(e)}function O(e){return"boolean"==typeof e.allow_unsafe_link_target&&e.allow_unsafe_link_target}function f(e,t){function n(e){return e.filter(function(e){return-1===I.inArray(i,e)})}var o,i=["noopener"],l=e?e.split(/\s+/):[];return(l=t?(o=n(o=l)).length?o.concat(i):i:n(l)).length?I.trim(l.sort().join(" ")):null}function m(e,t){return t=t||e.selection.getNode(),b(t)?e.dom.select("a[href]",t)[0]:e.dom.getParent(t,"a[href]")}function n(e){return e&&"A"===e.nodeName&&e.href}function R(u,c){return function(s){u.undoManager.transact(function(){var e,t,n,o,i,l=u.selection.getNode(),r=m(u,l),a={href:s.href,target:s.target?s.target:null,rel:s.rel?s.rel:null,class:s.class?s.class:null,title:s.title?s.title:null};M(u.settings)||!1!==O(u.settings)||(a.rel=f(a.rel,"_blank"===a.target)),s.href===c.href&&(c.attach(),c={}),r?(u.focus(),s.hasOwnProperty("text")&&("innerText"in r?r.innerText=s.text:r.textContent=s.text),u.dom.setAttribs(r,a),u.selection.select(r),u.undoManager.add()):b(l)?(t=l,n=a,(i=(e=u).dom.select("img",t)[0])&&(o=e.dom.create("a",n),i.parentNode.insertBefore(o,i),o.appendChild(i))):s.hasOwnProperty("text")?u.insertContent(u.dom.createHTML("a",a,u.dom.encode(s.text))):u.execCommand("mceInsertLink",!1,a)})}}function N(l){return function(){l.undoManager.transact(function(){var e,t,n,o,i=l.selection.getNode();b(i)?(t=i,(o=(e=l).dom.select("img",t)[0])&&(n=e.dom.getParents(o,"a[href]",t)[0])&&(n.parentNode.insertBefore(o,n),e.dom.remove(n))):l.execCommand("unlink")})}}function o(e){return 0<I.grep(e,n).length}function A(e,i,t){return function n(e,o){return o=o||[],I.each(e,function(e){var t={text:e.text||e.title};e.menu?t.menu=n(e.menu):(t.value=e.value,i&&i(t)),o.push(t)}),o}(e,t||[])}function L(t,e,n){var o=t.selection.getRng();l.setEditorTimeout(t,function(){t.windowManager.confirm(e,function(e){t.selection.setRng(o),n(e)})})}function i(a,e){function t(e){var t=i.find("#text");(!t.value()||e.lastControl&&t.value()===e.lastControl.text())&&t.value(e.control.text()),i.find("#href").value(e.control.value())}function n(){s||!u||b.text||this.parent().parent().find("#text")[0].value(this.value())}var o,s,i,u,l,r,c,f,d,m,g,h,v,x,p,k,y,b={},_=a.selection,w=a.dom;y=_.getContent(),u=!(/</.test(y)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(y)||-1===y.indexOf("href="))),o=K(a),b.text=(p=a.selection,s=((k=o)?k.innerText||k.textContent:p.getContent({format:"text"})).replace(/\uFEFF/g,"")),b.href=o?w.getAttrib(o,"href"):"",o?b.target=w.getAttrib(o,"target"):"string"==typeof a.settings.default_link_target&&(b.target=a.settings.default_link_target),(g=w.getAttrib(o,"rel"))&&(b.rel=g),(g=w.getAttrib(o,"class"))&&(b.class=g),(g=w.getAttrib(o,"title"))&&(b.title=g),u&&(l={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){b.text=this.value()}}),e&&(r={type:"listbox",label:"Link list",values:A(e,function(e){e.value=a.convertURL(e.value||e.url,"href")},[{text:"None",value:""}]),onselect:t,value:a.convertURL(b.href,"href"),onPostRender:function(){r=this}}),x=a.settings,!1!==T(x)&&(void 0===P(a.settings)&&(v=[{text:"None",value:""},{text:"New window",value:"_blank"}],a.settings.target_list=v),f={name:"target",type:"listbox",label:"Target",values:A(P(a.settings))}),M(a.settings)&&(c={name:"rel",type:"listbox",label:"Rel",values:A(E(a.settings),function(e){!1===O(a.settings)&&(e.value=U(e.value,"_blank"===b.target))})}),h=a.settings,void 0!==C(h)&&(d={name:"class",type:"listbox",label:"Class",values:A(S(a.settings),function(e){e.value&&(e.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[e.value]})})})}),!1!==a.settings.link_title&&(m={name:"title",type:"textbox",label:"Title",value:b.title}),i=a.windowManager.open({title:"Insert link",data:b,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:function(e){var t=e.meta||{};r&&r.value(a.convertURL(this.value(),"href")),I.each(e.meta,function(e,t){var n=i.find("#"+t);"text"===t?0===s.length&&(n.value(e),b.text=e):n.value(e)}),t.attach&&(D={href:this.value(),attach:t.attach}),t.text||n.call(this)},onkeyup:n,onpaste:n,onbeforecall:function(e){e.meta=i.toJSON()}},l,m,function(n){var o=[];if(I.each(a.dom.select("a:not([href])"),function(e){var t=e.name||e.id;t&&o.push({text:t,value:"#"+t,selected:-1!==n.indexOf("#"+t)})}),o.length)return o.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:o,onselect:t}}(b.href),r,c,f,d],onSubmit:function(e){var t,n="boolean"==typeof(t=a.settings).link_assume_external_targets&&t.link_assume_external_targets,o=R(a,D),i=N(a),l=I.extend({},b,e.data),r=l.href;r?(u&&l.text!==s||delete l.text,0<r.indexOf("@")&&-1===r.indexOf("//")&&-1===r.indexOf("mailto:")?L(a,"The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(e){e&&(l.href="mailto:"+r),o(l)}):!0===n&&!/^\w+:/i.test(r)||!1===n&&/^\s*www[\.|\d\.]/i.test(r)?L(a,"The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(e){e&&(l.href="http://"+r),o(l)}):o(l)):i()}})}function a(e,t){return e.dom.getParent(t,"a[href]")}function s(e){return a(e,e.selection.getStart())}function u(e,t){var n,o,i,l,r,a,s,u,c,f;t&&(n=(f=t).getAttribute("data-mce-href")||f.getAttribute("href"),/^#/.test(n)?(o=e.$(n)).length&&e.selection.scrollIntoView(o[0],!0):(i=t.href,!y.ie||10<y.ie?((l=d.document.createElement("a")).target="_blank",l.href=i,l.rel="noreferrer noopener",(r=d.document.createEvent("MouseEvents")).initMouseEvent("click",!0,!0,d.window,0,0,0,0,0,!1,!1,!1,!1,0,null),u=l,c=r,d.document.body.appendChild(u),u.dispatchEvent(c),d.document.body.removeChild(u)):(a=d.window.open("","_blank"))&&(a.opener=null,(s=a.document).open(),s.write('<meta http-equiv="refresh" content="0; url='+k.DOM.encode(i)+'">'),s.close())))}function c(o){return function(){var t,e,n;n=i,"string"==typeof(e=(t=o).settings.link_list)?r.send({url:e,success:function(e){n(t,JSON.parse(e))}}):"function"==typeof e?e(function(e){n(t,e)}):n(t,e)}}function g(e){return function(){u(e,s(e))}}function h(r){return function(e){var t,n,o,i,l;return!!("boolean"==typeof(l=r.settings).link_context_toolbar&&l.link_context_toolbar&&(!(i=r.plugins.contextmenu)||!i.isContextMenuVisible())&&_(e)&&3===(o=(n=(t=r.selection).getRng()).startContainer).nodeType&&t.isCollapsed()&&0<n.startOffset&&n.startOffset<o.data.length)}}function v(n){return function(){var t=this;n.on("nodechange",function(e){t.active(!n.readonly&&!!K(n,e.element))})}}function x(n){return function(){function e(e){o(e.parents)?t.show():t.hide()}var t=this;o(n.dom.getParents(n.selection.getStart()))||t.hide(),n.on("nodechange",e),t.on("remove",function(){n.off("nodechange",e)})}}var e=tinymce.util.Tools.resolve("tinymce.PluginManager"),p=tinymce.util.Tools.resolve("tinymce.util.VK"),P=T,E=t,S=C,k=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),y=tinymce.util.Tools.resolve("tinymce.Env"),I=tinymce.util.Tools.resolve("tinymce.util.Tools"),b=function(e){return e&&"FIGURE"===e.nodeName&&/\bimage\b/i.test(e.className)},_=n,K=m,U=f,l=tinymce.util.Tools.resolve("tinymce.util.Delay"),r=tinymce.util.Tools.resolve("tinymce.util.XHR"),D={};e.add("link",function(e){var t,n,o,i,l,r;(r=e).addButton("link",{active:!1,icon:"link",tooltip:"Insert/edit link",onclick:c(r),onpostrender:v(r)}),r.addButton("unlink",{active:!1,icon:"unlink",tooltip:"Remove link",onclick:N(r),onpostrender:v(r)}),r.addContextToolbar&&r.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:g(r)}),(l=e).addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:g(l),onPostRender:x(l),prependToContext:!0}),l.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:c(l),stateSelector:"a[href]",context:"insert",prependToContext:!0}),l.addMenuItem("unlink",{icon:"unlink",text:"Remove link",onclick:N(l),stateSelector:"a[href]"}),(i=e).addContextToolbar&&i.addContextToolbar(h(i),"openlink | link unlink"),(o=e).on("click",function(e){var t=a(o,e.target);t&&p.metaKeyPressed(e)&&(e.preventDefault(),u(o,t))}),o.on("keydown",function(e){var t=s(o);t&&13===e.keyCode&&!0===e.altKey&&!1===e.shiftKey&&!1===e.ctrlKey&&!1===e.metaKey&&(e.preventDefault(),u(o,t))}),(n=e).addCommand("mceLink",c(n)),(t=e).addShortcut("Meta+K","",c(t))})}(window);