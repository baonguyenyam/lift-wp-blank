"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(v){var w=window.wfi18n.__,s=window.wfi18n.sprintf;LiveTrafficViewModel=function(e,t){var r=this,o={};r.listings=ko.observableArray(e),r.listings.subscribe(function(e){o={};for(var t=0;t<e.length;t++)o[e[t].id()]=1}),r.hasListing=function(e){return e in o},r.filters=ko.observableArray(t);var i=new k("url",w("URL")),n=[new k("type",w("Type")),new k("user_login",w("Username")),new k("statusCode",w("HTTP Response Code")),new k("action",w("Firewall Response"),"enum",["ok","throttled","lockedOut","blocked","blocked:waf"]),new k("ip",w("IP")),i];r.presetFiltersOptions=ko.observableArray([new f(w("All Hits"),"all",[]),new f(w("Humans"),"humans",[new u(r,"type","human")]),new f(w("Registered Users"),"users",[new u(r,"userID","0","!=")]),new f(w("Crawlers"),"crawlers",[new u(r,"type","bot")]),new f(w("Google Crawlers"),"google",[new u(r,"isGoogle","1")]),new f(w("Pages Not Found"),"404s",[new u(r,"statusCode","404")]),new f(w("Logins and Logouts"),"logins",[new u(r,"action","login","contains"),new u(r,"action","logout","contains")]),new f(w("Locked Out"),"lockedOut",[new u(r,"action","lockedOut")]),new f(w("Blocked"),"blocked",[new u(r,"action","blocked","contains")]),new f(w("Blocked By Firewall"),"blocked:waf",[new u(r,"action","blocked:waf")])]),r.showAdvancedFilters=ko.observable(!1),r.showAdvancedFilters.subscribe(function(e){e&&0==r.filters().length&&r.addFilter()}),r.presetFiltersOptionsText=function(e){return e.text()},r.selectedPresetFilter=ko.observable(),r.selectedPresetFilter.subscribe(function(e){for(var t=ko.toJS(e.filters()),o=[],i=0;i<t.length;i++)o.push(new u(r,t[i].param,t[i].value,t[i].operator));r.filters(o),r.groupBy(e.groupBy())}),r.filters.subscribe(function(){r.checkQueryAndReloadListings()}),r.addFilter=function(){r.filters.push(new u(r))},r.removeFilter=function(e){r.filters.remove(e)};function a(){var t="";ko.utils.arrayForEach(r.filters(),function(e){!1!==e.getValue()&&(t+=e.urlEncoded()+"&")});var e=r.groupBy();e&&(t+="groupby="+encodeURIComponent(e.param())+"&");var o=r.startDate();o&&(t+="startDate="+encodeURIComponent(o)+"&");var i=r.endDate();return i&&(t+="endDate="+encodeURIComponent(i)+"&"),1<t.length?t.substring(0,t.length-1):""}var s="";r.filterGroupByOptions=ko.observableArray(n),r.filterGroupByOptionsText=function(e){return e.text()||e.param()},r.groupBy=ko.observable(),r.groupBy.subscribe(function(){r.checkQueryAndReloadListings()}),r.startDate=ko.observable(),r.startDate.subscribe(function(){r.checkQueryAndReloadListings()}),r.endDate=ko.observable(),r.endDate.subscribe(function(){r.checkQueryAndReloadListings()}),r.checkQueryAndReloadListings=function(e){s!==a()&&r.reloadListings(e)},r.reloadListings=function(e){l(e,function(e){var t=r.groupBy(),o="";t?(o=t.param(),WFAD.mode="liveTraffic_paused"):WFAD.mode="liveTraffic";for(var i=[],n=0;n<e.length;n++)i.push(new c(e[n],o));r.listings(i)})},r.loadNextListings=function(e){var t=r.filters[0];l({since:t,limit:50,offset:r.listings().length},function(){r.appendListings.apply(this,arguments),"function"==typeof e&&e.apply(this,arguments)})},r.getCurrentQueryString=function(e){var t={since:null,limit:50,offset:0};for(var o in t)t.hasOwnProperty(o)&&e&&o in e&&(t[o]=e[o]);var i,n=s=a();for(o in t){t.hasOwnProperty(o)&&(null==(i=t[o])&&(i=""),n+="&"+encodeURIComponent(o)+"="+encodeURIComponent(i))}return n};var l=function(e,t){var o=r.getCurrentQueryString(e);WFAD.ajax("wordfence_loadLiveTraffic",o,function(e){e&&e.success&&(t&&t(e.data,e),r.sql(e.sql))})};r.prependListings=function(e,t){for(var o,i=e.length-1;0<=i;i--){r.hasListing(e[i].id)||((o=new c(e[i])).highlighted(!0),r.listings.unshift(o))}},r.appendListings=function(e,t){for(var o,i=3,n=0;n<e.length;n++){r.hasListing(e[n].id)||((o=new c(e[n])).highlighted(0<i--),r.listings.push(o))}},r.whitelistWAFParamKey=function(e,t,o){WFAD.ajax("wordfence_whitelistWAFParamKey",{path:e,paramKey:t,failedRules:o},function(e){})},r.trimIP=function(e){return e&&16<e.length?e.substring(0,16)+"…":e},v(window).on("wf-live-traffic-ip-blocked",function(e,t){ko.utils.arrayForEach(r.listings(),function(e){e.IP()===t&&e.blocked(!0)})}).on("wf-live-traffic-ip-unblocked",function(e,t){ko.utils.arrayForEach(r.listings(),function(e){e.IP()===t&&e.blocked(!1)})}),r.sql=ko.observable("")},LiveTrafficViewModel.truncateText=function(e,t){return t=t||100,e&&e.length>t?e.substring(0,Math.round(t))+"…":e};var c=function(e,r){var a=this;for(var t in a.id=ko.observable(0),a.ctime=ko.observable(0),a.IP=ko.observable(""),a.jsRun=ko.observable(0),a.statusCode=ko.observable(200),a.isGoogle=ko.observable(0),a.userID=ko.observable(0),a.URL=ko.observable(""),a.referer=ko.observable(""),a.UA=ko.observable(""),a.loc=ko.observable(),a.type=ko.observable(""),a.blocked=ko.observable(!1),a.rangeBlocked=ko.observable(!1),a.ipRangeID=ko.observable(-1),a.extReferer=ko.observable(),a.browser=ko.observable(),a.user=ko.observable(),a.hitCount=ko.observable(),a.username=ko.observable(""),a.action=ko.observable(""),a.actionDescription=ko.observable(!1),a.actionData=ko.observable(),a.highlighted=ko.observable(!1),a.showDetails=ko.observable(!1),a.toggleDetails=function(){a.showDetails(!a.showDetails())},e)e.hasOwnProperty(t)&&("blocked"!==t&&"rangeBlocked"!==t||(e[t]=!!e[t]),void 0!==a[t]&&a[t](e[t]));function o(){i.fadeIn(400),n.css({right:"-800px"}).stop().animate({right:0},500)}void 0!==e.lastHit&&a.ctime(e.lastHit),a.timestamp=ko.pureComputed(function(){var e=new Date(1e3*a.ctime());return e.toLocaleDateString()+" "+e.toLocaleTimeString()},a),a.timeAgo=ko.pureComputed(function(){var e=WFAD.serverMicrotime;return v(WFAD.showTimestamp(this.ctime(),e)).text()},a),a.displayURL=ko.pureComputed(function(){return LiveTrafficViewModel.truncateText(a.URL(),105)}),a.displayURLShort=ko.pureComputed(function(){var e=document.createElement("a");if(!a.URL())return"";if(e.href=a.URL(),e.host!==location.host)return LiveTrafficViewModel.truncateText(a.URL(),30);var t=e.pathname+("string"==typeof e.search?e.search:"");return LiveTrafficViewModel.truncateText(t,30)}),a.firewallAction=ko.pureComputed(function(){if("action"==r)switch(a.action()){case"lockedOut":return w("Locked out from logging in");case"blocked:waf-always":return w("Blocked by the Wordfence Application Firewall and plugin settings");case"blocked:wordfence":return w("Blocked by Wordfence plugin settings");case"blocked:wfsnrepeat":case"blocked:wfsn":return w("Blocked by the Wordfence Security Network");case"blocked:waf":return w("Blocked by the Wordfence Web Application Firewall");case"cbl:redirect":return w("Redirected by Country Blocking bypass URL");default:return w("Blocked by Wordfence")}var e="";switch(a.action()){case"lockedOut":return w("locked out from logging in");case"blocked:waf-always":case"blocked:wordfence":case"blocked:wfsnrepeat":return(e=a.actionDescription())&&0===e.toLowerCase().indexOf("block")?"b"+e.substring(1):s(w("blocked for %s"),e);case"blocked:wfsn":return w("blocked by the Wordfence Security Network");case"blocked:waf":var t=a.actionData();if("object"!==_typeof(t))return s(w("blocked by firewall for %s"),a.actionDescription());var o=WFAD.base64_decode(t.paramKey),i=WFAD.base64_decode(t.paramValue),n=o.match(/([a-z0-9_]+\.[a-z0-9_]+)(?:\[(.+?)\](.*))?/i),e=a.actionDescription();if(n)switch(n[1]){case"request.queryString":e=s(w("%s in query string: %s"),a.actionDescription(),n[2]+"="+LiveTrafficViewModel.truncateText(encodeURIComponent(i)));break;case"request.body":e=s(w("%s in POST body: %s"),a.actionDescription(),n[2]+"="+LiveTrafficViewModel.truncateText(encodeURIComponent(i)));break;case"request.cookie":e=s(w("%s in cookie: %s"),a.actionDescription(),n[2]+"="+LiveTrafficViewModel.truncateText(encodeURIComponent(i)));break;case"request.fileNames":e=s(w("%s in file: %s"),a.actionDescription(),n[2]+"="+LiveTrafficViewModel.truncateText(encodeURIComponent(i)))}return e?s(w("blocked by firewall for %s"),e):"blocked"==t.failedRules?w("blocked by real-time IP blocklist"):w("blocked by firewall");case"cbl:redirect":return e=a.actionDescription()}return e}),a.cssClasses=ko.pureComputed(function(){var e="wf-live-traffic-hit-type";return 403!=a.statusCode()&&503!=a.statusCode()||(e+=" wfActionBlocked"),404==a.statusCode()&&(e+=" wf404"),1==a.jsRun()&&(e+=" wfHuman"),a.actionData()&&a.actionData().learningMode&&(e+=" wfWAFLearningMode"),"loginFailValidUsername"!=a.action()&&"loginFailInvalidUsername"!=a.action()||(e+=" wfFailedLogin"),e}),a.typeIconClass=ko.pureComputed(function(){var e="wf-live-traffic-type-icon";return 403==a.statusCode()||503==a.statusCode()?e+=" wf-icon-blocked wf-ion-android-cancel":404==a.statusCode()||"loginFailValidUsername"==a.action()||"loginFailInvalidUsername"==a.action()?e+=" wf-icon-warning wf-ion-alert-circled":1==a.jsRun()?e+=" wf-icon-human wf-ion-ios-person":e+=" wf-ion-bug",e}),a.typeText=ko.pureComputed(function(){var e="",e="loginFailValidUsername"==a.action()||"loginFailInvalidUsername"==a.action()?w("Failed Login"):403==a.statusCode()||503==a.statusCode()?w("Blocked"):404==a.statusCode()?w("404 Not Found"):302==a.statusCode()?w("Redirected"):1==a.jsRun()?w("Human"):w("Bot");return s(w("Type: %s"),e)}),a.showWhoisOverlay=function(){o(),g.html(v("#wfActEvent_"+a.id()).html()),h.html("").css("opacity",0),WFAD.ajax("wordfence_whois",{val:a.IP()},function(e){var t=WFAD.completeWhois(e,!0);h.stop().animate({opacity:1},200).html("<h4 style='margin-top:0;'>"+w("WHOIS LOOKUP")+"</h4>"+t),v(window).trigger("wf-live-traffic-overlay-bind",a)})},a.showRecentTraffic=function(){o(),g.html(v("#wfActEvent_"+a.id()).html()),h.html("").css("opacity",0),WFAD.ajax("wordfence_recentTraffic",{ip:a.IP()},function(e){h.stop().animate({opacity:1},200).html("<h3 style='margin-top:0;'>"+w("Recent Activity")+"</h3>"+e.result),v(window).trigger("wf-live-traffic-overlay-bind",a),WFAD.avatarLookup()})},a.unblockIP=function(){WFAD.unblockIP(a.IP(),function(){v(window).trigger("wf-live-traffic-ip-unblocked",a.IP())})},a.unblockNetwork=function(){WFAD.unblockNetwork(a.ipRangeID())},a.blockIP=function(){WFAD.blockIP(a.IP(),w("Manual block by administrator"),function(){v(window).trigger("wf-live-traffic-ip-blocked",a.IP())})}},u=function(e,t,o,i){var n=this;n.viewModel=e,n.param=ko.observable(""),n.value=ko.observable(""),n.operator=ko.observable(""),n.param(t),n.value(o),n.operator(i||"=");function r(){n.viewModel&&n.viewModel.checkQueryAndReloadListings&&n.viewModel.checkQueryAndReloadListings()}n.param.subscribe(r),n.operator.subscribe(r),n.value.subscribe(function(e){e instanceof p&&e.operator()&&n.selectedFilterOperatorOptionValue(e.operator()),r()});var a=new b("="),s=new b("!=","≠"),l=new b("contains"),c=new b("match");n.filterOperatorOptions=ko.observableArray([a,s,l,c]),n.filterParamOptions=ko.observableArray([new d("type",w("Type"),"enum",[new p("human",w("Human")),new p("bot",w("Bot"))]),new d("user_login",w("Username")),new d("userID",w("User ID")),new d("isGoogle",w("Google Bot"),"bool"),new d("ip",w("IP")),new d("ua",w("User Agent")),new d("referer",w("Referer")),new d("url",w("URL")),new d("statusCode",w("HTTP Response Code")),new d("action",w("Firewall Response"),"enum",[new p("",w("OK")),new p("throttled",w("Throttled")),new p("lockedOut",w("Locked Out")),new p("blocked",w("Blocked"),l),new p("blocked:waf",w("Blocked WAF"))]),new d("action",w("Logins"),"enum",[new p("loginOK",w("Logged In")),new p("loginFail",w("Failed Login")),new p("loginFailInvalidUsername",w("Failed Login: Invalid Username")),new p("loginFailValidUsername",w("Failed Login: Valid Username"))]),new d("action",w("Security Event"))]),n.filterParamOptionsText=function(e){return e.text()||e.param()},n.selectedFilterParamOptionValue=ko.observable(),n.selectedFilterParamOptionValue.subscribe(function(e){n.param(e&&e.param?e.param():"")}),ko.utils.arrayForEach(n.filterParamOptions(),function(t){if(n.param()==t.param())switch(t.type()){case"enum":switch(n.operator()){case"=":ko.utils.arrayForEach(t.values(),function(e){e.value()==n.value()&&n.selectedFilterParamOptionValue(t)})}break;default:n.selectedFilterParamOptionValue(t)}}),n.filterOperatorOptionsText=function(e){return e.text()||e.operator()},n.selectedFilterOperatorOptionValue=ko.observable(),n.selectedFilterOperatorOptionValue.subscribe(function(e){n.operator(e.operator())}),ko.utils.arrayForEach(n.filterOperatorOptions(),function(e){n.operator()==e.operator()&&n.selectedFilterOperatorOptionValue(e)}),n.getValue=function(){var e=n.value()instanceof p?n.value().value():n.value();return("string"==typeof e||"number"==typeof e)&&e},n.urlEncoded=function(){var e=n.getValue();return"param[]="+encodeURIComponent(n.param())+"&value[]="+encodeURIComponent(e)+"&operator[]="+encodeURIComponent(n.operator())}},f=function(e,t,o,i){this.text=ko.observable(""),this.value=ko.observable(""),this.filters=ko.observableArray(o),this.groupBy=ko.observable(i),this.text(e),this.value(t)},d=function(e,t,o,i){this.text=ko.observable(""),this.param=ko.observable(""),this.type=ko.observable(""),this.values=ko.observableArray(i),this.text(t),this.param(e),this.type(o||"text"),this.optionsText=function(e){return e instanceof p?e.label()||e.value():e}},p=function(e,t,o){this.value=ko.observable(""),this.label=ko.observable(""),this.operator=ko.observable(""),this.value=ko.observable(e),this.label=ko.observable(t),this.operator=ko.observable(o),this.toString=function(){return this.value()}},b=function(e,t){this.text=ko.observable(""),this.operator=ko.observable(""),this.text(t),this.operator(e)},k=function(e,t){this.text=ko.observable(""),this.param=ko.observable(""),this.text(t),this.param(e)};ko.bindingHandlers.datetimepicker={init:function(e,t,o){var i=o().datepickerOptions||{},n=v(e);n.datetimepicker(i),ko.utils.registerEventHandler(e,"changeDate",function(){t()(n.datetimepicker("getDate"))}),ko.utils.domNodeDisposal.addDisposeCallback(e,function(){n.datetimepicker("destroy")})},update:function(e,t){var o=ko.utils.unwrapObservable(t()),i=v(e);0==String(o).indexOf("/Date(")&&(o=new Date(parseInt(o.replace(/\/Date\((.*?)\)\//gi,"$1")))),o-i.datetimepicker("getDate")!=0&&i.datetimepicker("setDate",o)}};var i=null,n=null,t=null,g=null,h=null;v(function(){var a=v("#wf-live-traffic");v("#wf-lt-preset-filters").wfselect2({templateSelection:function(e){return v("<span><em>"+w("Filter Traffic")+"</em>: "+e.text+"</span>")}}),i=v("#wf-live-traffic-util-overlay-wrapper").on("click",function(e){e.target===this&&t.trigger("click")}),n=i.find(".wf-live-traffic-util-overlay"),t=i.find(".wf-live-traffic-util-overlay-close").on("click",function(){i.fadeOut(250),n.stop().animate({right:"-800px"},250),g.html(""),h.html("").css("opacity",0),v(window).trigger("wf-live-traffic-overlay-unbind")}),g=i.find(".wf-live-traffic-util-overlay-header"),h=i.find(".wf-live-traffic-util-overlay-body"),v([g,h]).on("click",function(){return!1}),WFAD.wfLiveTraffic=new LiveTrafficViewModel,ko.applyBindings(WFAD.wfLiveTraffic,a.get(0)),a.find("form").submit(),WFAD.mode="liveTraffic";var s=v("#wf-live-traffic-legend-wrapper"),l=v("#wf-live-traffic-legend-placeholder"),c=v("#wf-live-traffic-legend"),u=v("#wpadminbar"),f=v("#wf-lt-listings"),d=v("div#wf-live-traffic-group-by"),p=!1,b=!1;v(window).on("scroll",function(){var e,t,o=v(this);(WFAD.isSmallScreen?s.offset().top<o.scrollTop()+10:s.offset().top<o.scrollTop()+u.outerHeight()+10)?(e=c.width(),t=c.height(),c.addClass("sticky"),c.css("width",e),c.css("height",t),l.addClass("sticky"),l.css("width",e),l.css("height",t)):(c.removeClass("sticky"),c.css("width","auto"),c.css("height","auto"),l.removeClass("sticky"));var i=f.children().filter(":visible").first();0<i.length&&i.offset().top+i.height()<o.scrollTop()+u.outerHeight()+20||0<d.filter(":visible").length?"liveTraffic_paused"!=WFAD.mode&&(WFAD.mode="liveTraffic_paused"):"liveTraffic"!=WFAD.mode&&(WFAD.mode="liveTraffic");var n=o.scrollTop()+window.innerHeight,r=a.outerHeight()+a.offset().top;p&&!b&&r<=n?(p=!(b=!0),WFAD.wfLiveTraffic.loadNextListings(function(){b=!1,WFAD.reverseLookupIPs(),WFAD.avatarLookup()})):n<r&&(p=!0)}).on("wf-live-traffic-overlay-bind",function(e,t){ko.applyBindings(t,g.get(0))}).on("wf-live-traffic-overlay-unbind",function(e,t){ko.cleanNode(g.get(0))}),v([a.find(".wf-filtered-traffic"),i]).tooltip({tooltipClass:"wf-tooltip",track:!0})})}(jQuery);